{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Enhanced Page Header -->
    <div class="page-header mb-8">
        <div class="page-header-content">
            <div>
                <h1 class="page-title">Bioreactors</h1>
                <p class="page-subtitle">Manage and monitor your laboratory bioreactors</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary">
                    üìä Analytics
                </button>
                <button class="btn btn-secondary">
                    ‚öôÔ∏è Settings
                </button>
                <a href="/app/bioreactors/enroll" class="btn btn-primary">
                    ‚ûï Enroll Bioreactor
                </a>
            </div>
        </div>
    </div>

    <!-- Enhanced Controls -->
    <form method="get" class="controls-section mb-6">
        <div class="controls-content">
            <div class="search-filters">
                <div class="search-box">
                    <div class="search-icon">üîç</div>
                    <input type="text" class="search-input" placeholder="Search bioreactors..." name="search" value="{{ filters.search or '' }}">
                </div>
                <select name="organization_id" class="filter-select">
                    <option value="">All Organizations</option>
                    {% for org in organizations %}
                    <option value="{{ org.id }}" {% if selected_org and selected_org.id == org.id %}selected{% endif %}>
                        {{ org.name }}
                    </option>
                    {% endfor %}
                </select>
                <select name="status" class="filter-select">
                    <option value="">All Status</option>
                    <option value="online" {% if filters.status == 'online' %}selected{% endif %}>Online</option>
                    <option value="offline" {% if filters.status == 'offline' %}selected{% endif %}>Offline</option>
                    <option value="maintenance" {% if filters.status == 'maintenance' %}selected{% endif %}>Maintenance</option>
                    <option value="error" {% if filters.status == 'error' %}selected{% endif %}>Error</option>
                </select>
                <select name="bioreactor_type" class="filter-select">
                    <option value="">All Types</option>
                    <option value="stirred_tank" {% if filters.bioreactor_type == 'stirred_tank' %}selected{% endif %}>Stirred Tank</option>
                    <option value="airlift" {% if filters.bioreactor_type == 'airlift' %}selected{% endif %}>Airlift</option>
                    <option value="packed_bed" {% if filters.bioreactor_type == 'packed_bed' %}selected{% endif %}>Packed Bed</option>
                    <option value="fluidized_bed" {% if filters.bioreactor_type == 'fluidized_bed' %}selected{% endif %}>Fluidized Bed</option>
                </select>
                <button type="submit" class="btn btn-primary">
                    Filter
                </button>
            </div>
            <div class="view-toggles">
                <button type="button" class="view-toggle active" id="grid-view" title="Grid View">‚öè</button>
                <button type="button" class="view-toggle" id="list-view" title="List View">‚ò∞</button>
            </div>
        </div>
    </form>

    <!-- Statistics Section -->
    {% if stats %}
    <div class="stats-section mb-6">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üî¨</div>
                <div class="stat-content">
                    <span class="stat-value">{{ stats.total_bioreactors }}</span>
                    <span class="stat-label">Total Bioreactors</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üü¢</div>
                <div class="stat-content">
                    <span class="stat-value">{{ stats.online_bioreactors }}</span>
                    <span class="stat-label">Online</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üî¥</div>
                <div class="stat-content">
                    <span class="stat-value">{{ stats.offline_bioreactors }}</span>
                    <span class="stat-label">Offline</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üß™</div>
                <div class="stat-content">
                    <span class="stat-value">{{ stats.running_experiments }}</span>
                    <span class="stat-label">Running Experiments</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <span class="stat-value">{{ "%.1f"|format(stats.average_vessel_volume) }}L</span>
                    <span class="stat-label">Avg Vessel Volume</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Message -->
    {% if error %}
    <div class="alert alert-error mb-6">
        <p>{{ error }}</p>
    </div>
    {% endif %}

    <!-- Bioreactors Grid View -->
    {% if bioreactors %}
    <div class="bioreactors-grid" id="bioreactors-grid">
        {% for bioreactor in bioreactors %}
        <div class="bioreactor-card">
            <div class="bioreactor-header">
                <div class="bioreactor-status status-{{ bioreactor.get_status() }}">
                    ‚óè {{ bioreactor.get_status()|title }}
                </div>
                <div class="bioreactor-org">{{ bioreactor.organization.name if bioreactor.organization else 'No Organization' }}</div>
                <h3 class="bioreactor-name">{{ bioreactor.name }}</h3>
                {% if bioreactor.description %}
                <p class="bioreactor-description">{{ bioreactor.description }}</p>
                {% endif %}
                <div class="bioreactor-progress">
                    <div class="progress-label">
                        <span>Status</span>
                        <span>{{ bioreactor.get_status()|title }}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill {% if bioreactor.get_status() == 'online' %}progress-fill-100{% elif bioreactor.get_status() == 'offline' %}progress-fill-0{% else %}progress-fill-50{% endif %}"></div>
                    </div>
                </div>
            </div>
            
            <div class="bioreactor-stats">
                <div class="stat">
                    <span class="stat-number">{{ bioreactor.get_vessel_volume()|round(1) }}</span>
                    <span class="stat-label">Vessel (L)</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ bioreactor.get_working_volume()|round(1) if bioreactor.get_working_volume() else 0 }}</span>
                    <span class="stat-label">Working (L)</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ bioreactor.get_sensors()|length }}</span>
                    <span class="stat-label">Sensors</span>
                </div>
            </div>
            
            <div class="bioreactor-details">
                <div class="detail-item">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">{{ bioreactor.get_bioreactor_type()|title }}</span>
                </div>
                
                <div class="detail-item">
                    <span class="detail-label">Control Mode:</span>
                    <span class="detail-value">{{ bioreactor.get_control_mode()|title }}</span>
                </div>
                
                {% if bioreactor.get_location() %}
                <div class="detail-item">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">{{ bioreactor.get_location() }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="bioreactor-sensors">
                <h4>Sensors</h4>
                <div class="sensors-list">
                    {% for sensor in bioreactor.get_sensors() %}
                    <span class="sensor-badge">{{ sensor.type|title }}</span>
                    {% endfor %}
                    {% if not bioreactor.get_sensors() %}
                    <span class="sensor-badge empty">No sensors</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="bioreactor-actuators">
                <h4>Actuators</h4>
                <div class="actuators-list">
                    {% for actuator in bioreactor.get_actuators() %}
                    <span class="actuator-badge">{{ actuator.type|title }}</span>
                    {% endfor %}
                    {% if not bioreactor.get_actuators() %}
                    <span class="actuator-badge empty">No actuators</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="bioreactor-footer">
                <div class="bioreactor-info">
                    {% if bioreactor.is_running_experiment() %}
                    <span class="experiment-badge">Running Experiment</span>
                    {% endif %}
                    
                    {% if bioreactor.get_last_seen() %}
                    <span class="last-seen">Last seen: {{ bioreactor.get_last_seen()|timeago }}</span>
                    {% endif %}
                </div>
                <div class="bioreactor-actions">
                    <a href="/app/bioreactors/{{ bioreactor.id }}" class="action-btn" title="View Details">üëÅÔ∏è</a>
                    <a href="/app/bioreactors/{{ bioreactor.id }}/control" class="action-btn" title="Control">üéÆ</a>
                    <a href="/app/bioreactors/{{ bioreactor.id }}/edit" class="action-btn" title="Edit">‚úèÔ∏è</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Bioreactors List View -->
    <div class="bioreactors-list hidden" id="bioreactors-list">
        <div class="list-header">
            <div>Bioreactor Name</div>
            <div>Organization</div>
            <div>Status</div>
            <div>Type</div>
            <div>Volume</div>
            <div>Actions</div>
        </div>
        {% for bioreactor in bioreactors %}
        <div class="bioreactor-row">
            <div class="bioreactor-info">
                <strong>{{ bioreactor.name }}</strong>
                {% if bioreactor.description %}
                <br>
                <small class="bioreactor-desc">{{ bioreactor.description[:50] }}{% if bioreactor.description|length > 50 %}...{% endif %}</small>
                {% endif %}
            </div>
            <div>{{ bioreactor.organization.name if bioreactor.organization else 'No Organization' }}</div>
            <div><span class="status-{{ bioreactor.get_status() }}">‚óè {{ bioreactor.get_status()|title }}</span></div>
            <div>{{ bioreactor.get_bioreactor_type()|title }}</div>
            <div>{{ "%.1f"|format(bioreactor.get_vessel_volume()) }}L</div>
            <div class="bioreactor-actions">
                <a href="/app/bioreactors/{{ bioreactor.id }}" class="action-btn" title="View">üëÅÔ∏è</a>
                <a href="/app/bioreactors/{{ bioreactor.id }}/control" class="action-btn" title="Control">üéÆ</a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="pagination">
        <div class="pagination-info">
            Showing {{ (pagination.page - 1) * 20 + 1 }} to 
            {{ pagination.page * 20 if pagination.page * 20 < pagination.total_count else pagination.total_count }} 
            of {{ pagination.total_count }} bioreactors
        </div>
        
        <div class="pagination-controls">
            {% if pagination.page > 1 %}
            <a href="?page={{ pagination.page - 1 }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}" 
               class="btn btn-sm btn-outline">Previous</a>
            {% endif %}
            
            <span class="page-info">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
            
            {% if pagination.page < pagination.total_pages %}
            <a href="?page={{ pagination.page + 1 }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}" 
               class="btn btn-sm btn-outline">Next</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Enhanced Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
            </svg>
        </div>
        <h3 class="empty-title">No bioreactors yet</h3>
        <p class="empty-description">
            {% if filters.status or filters.search %}
            No bioreactors match your current filters. Try adjusting your search criteria.
            {% else %}
            Enroll your first bioreactor to begin monitoring and controlling your experiments.
            {% endif %}
        </p>
        <a href="/app/bioreactors/enroll" class="btn btn-primary">
            Enroll Bioreactor
        </a>
    </div>
    {% endif %}
</div>

<script>
// View toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    const bioreactorsGrid = document.getElementById('bioreactors-grid');
    const bioreactorsList = document.getElementById('bioreactors-list');

    if (gridView && listView && bioreactorsGrid && bioreactorsList) {
        gridView.addEventListener('click', () => {
            gridView.classList.add('active');
            listView.classList.remove('active');
            bioreactorsGrid.classList.remove('hidden');
            bioreactorsList.classList.add('hidden');
        });

        listView.addEventListener('click', () => {
            listView.classList.add('active');
            gridView.classList.remove('active');
            bioreactorsGrid.classList.add('hidden');
            bioreactorsList.classList.remove('hidden');
        });
    }
});
</script>
{% endblock %} 