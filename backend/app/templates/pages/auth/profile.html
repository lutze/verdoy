{% extends "base.html" %}

{% block title %}Profile - LIM OS{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1>User Profile</h1>
        <p>Manage your account settings and preferences</p>
    </div>

    <!-- Profile Information Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>Profile Information</h2>
            <p>Update your personal information and account details</p>
        </div>
        
        <form action="/app/admin/profile" method="post" class="profile-form" id="profile-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            <input type="hidden" name="form_type" value="profile">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="name" class="form-label">Full Name</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="form-input" 
                        value="{{ user.name if user.name else '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        value="{{ user.email if user.email else '' }}"
                        readonly
                        title="Email cannot be changed"
                    >
                    <div class="form-hint">Contact support to change your email address</div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="organization_id" class="form-label">Organization</label>
                    <select 
                        id="organization_id" 
                        name="organization_id" 
                        class="form-input"
                    >
                        <option value="">No Organization</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if user.organization_id and user.organization_id == org.id %}selected{% endif %}>
                            {{ org.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-hint">Select the organization you belong to</div>
                </div>
                
                <div class="form-group">
                    <label for="created_at" class="form-label">Member Since</label>
                    <input 
                        type="text" 
                        id="created_at" 
                        class="form-input" 
                        value="{{ user.created_at.strftime('%B %d, %Y') if user.created_at else '' }}"
                        readonly
                    >
                </div>
            </div>
            
            {% if profile_errors %}
            <div class="alert alert-error">
                {% for error in profile_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if profile_success %}
            <div class="alert alert-success">
                {{ profile_success }}
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    Update Profile
                </button>
            </div>
        </form>
    </div>

    <!-- Password Change Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>Change Password</h2>
            <p>Keep your account secure with a strong password</p>
        </div>
        
        <form action="/auth/change-password" method="post" class="profile-form" id="password-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            <input type="hidden" name="form_type" value="password">
            
            <div class="form-group">
                <label for="current_password" class="form-label">Current Password</label>
                <input 
                    type="password" 
                    id="current_password" 
                    name="current_password" 
                    class="form-input" 
                    required
                    autocomplete="current-password"
                >
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="new_password" class="form-label">New Password</label>
                    <input 
                        type="password" 
                        id="new_password" 
                        name="new_password" 
                        class="form-input" 
                        required
                        minlength="8"
                        autocomplete="new-password"
                    >
                    <div class="form-hint">At least 8 characters long</div>
                </div>
                
                <div class="form-group">
                    <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                    <input 
                        type="password" 
                        id="confirm_new_password" 
                        name="confirm_new_password" 
                        class="form-input" 
                        required
                        autocomplete="new-password"
                    >
                    <div class="form-error" id="password-match-error"></div>
                </div>
            </div>
            
            {% if password_errors %}
            <div class="alert alert-error">
                {% for error in password_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if password_success %}
            <div class="alert alert-success">
                {{ password_success }}
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    Change Password
                </button>
            </div>
        </form>
    </div>

    <!-- API Keys Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>API Keys</h2>
            <p>Manage API keys for programmatic access</p>
        </div>
        
        <div class="api-keys-content">
            {% if api_keys and api_keys|length > 0 %}
            <div class="api-keys-list">
                {% for key in api_keys %}
                <div class="api-key-item">
                    <div class="api-key-info">
                        <div class="api-key-name">
                            <strong>{{ key.name if key.name else 'API Key' }}</strong>
                            {% if key.is_active %}
                                <span class="status-badge status-active">Active</span>
                            {% else %}
                                <span class="status-badge status-inactive">Inactive</span>
                            {% endif %}
                        </div>
                        <div class="api-key-details">
                            <span>Created: {{ key.created_at.strftime('%B %d, %Y') if key.created_at else 'Unknown' }}</span>
                            {% if key.last_used %}
                            <span>Last used: {{ key.last_used.strftime('%B %d, %Y') }}</span>
                            {% else %}
                            <span>Never used</span>
                            {% endif %}
                        </div>
                        <div class="api-key-value">
                            <input type="text" class="api-key-input" value="{{ key.masked_key }}" readonly>
                            <button type="button" class="btn btn-outline btn-sm" onclick="copyApiKey(this)">
                                Copy
                            </button>
                        </div>
                    </div>
                    <div class="api-key-actions">
                        <form action="/auth/api-keys/{{ key.id }}/revoke" method="post" class="form-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to revoke this API key?')">
                                Revoke
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No API keys created yet</p>
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="generateApiKey()">
                    Generate New API Key
                </button>
            </div>
        </div>
    </div>

    <!-- Account Actions Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>Account Actions</h2>
            <p>Manage your account settings</p>
        </div>
        
        <div class="account-actions">
                            <form action="/auth/logout" method="post" class="form-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                <button type="submit" class="btn btn-outline">
                    Sign Out
                </button>
            </form>
            
            <button type="button" class="btn btn-danger" onclick="showDeleteAccountModal()">
                Delete Account
            </button>
        </div>
    </div>
</div>



<script>
// Password confirmation validation
document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_new_password');
    const errorDiv = document.getElementById('password-match-error');
    
    function validatePasswordMatch() {
        if (confirmPassword.value && newPassword.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
            errorDiv.textContent = 'Passwords do not match';
        } else {
            confirmPassword.setCustomValidity('');
            errorDiv.textContent = '';
        }
    }
    
    newPassword.addEventListener('input', validatePasswordMatch);
    confirmPassword.addEventListener('input', validatePasswordMatch);
});

// Copy API key to clipboard
function copyApiKey(button) {
    const input = button.previousElementSibling;
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(input.value).then(function() {
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = 'Copy';
        }, 2000);
    });
}

// Generate new API key
function generateApiKey() {
    if (confirm('Generate a new API key? Make sure to copy it immediately as it will only be shown once.')) {
        // This would trigger an HTMX request or form submission
        window.location.href = '/auth/api-keys/generate';
    }
}

// Show delete account modal
function showDeleteAccountModal() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        if (confirm('This will permanently delete all your data. Type "DELETE" to confirm.')) {
            // This would trigger account deletion
            alert('Account deletion functionality would be implemented here');
        }
    }
}
</script>
{% endblock %} 