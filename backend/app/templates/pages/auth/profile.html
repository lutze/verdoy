{% extends "base.html" %}

{% block title %}Profile - LIM OS{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1>User Profile</h1>
        <p>Manage your account settings and preferences</p>
    </div>

    <!-- Profile Information Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>Profile Information</h2>
            <p>Update your personal information and account details</p>
        </div>
        
        <form action="/auth/me" method="post" class="profile-form" id="profile-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            <input type="hidden" name="form_type" value="profile">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="name" class="form-label">Full Name</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="form-input" 
                        value="{{ user.name if user.name else '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        value="{{ user.email if user.email else '' }}"
                        readonly
                        title="Email cannot be changed"
                    >
                    <div class="form-hint">Contact support to change your email address</div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="organization" class="form-label">Organization</label>
                    <input 
                        type="text" 
                        id="organization" 
                        name="organization" 
                        class="form-input" 
                        value="{{ organization.name if organization else 'No organization' }}"
                        readonly
                    >
                </div>
                
                <div class="form-group">
                    <label for="created_at" class="form-label">Member Since</label>
                    <input 
                        type="text" 
                        id="created_at" 
                        class="form-input" 
                        value="{{ user.created_at.strftime('%B %d, %Y') if user.created_at else '' }}"
                        readonly
                    >
                </div>
            </div>
            
            {% if profile_errors %}
            <div class="alert alert-error">
                {% for error in profile_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if profile_success %}
            <div class="alert alert-success">
                {{ profile_success }}
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    Update Profile
                </button>
            </div>
        </form>
    </div>

    <!-- Password Change Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>Change Password</h2>
            <p>Keep your account secure with a strong password</p>
        </div>
        
        <form action="/auth/change-password" method="post" class="profile-form" id="password-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            <input type="hidden" name="form_type" value="password">
            
            <div class="form-group">
                <label for="current_password" class="form-label">Current Password</label>
                <input 
                    type="password" 
                    id="current_password" 
                    name="current_password" 
                    class="form-input" 
                    required
                    autocomplete="current-password"
                >
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="new_password" class="form-label">New Password</label>
                    <input 
                        type="password" 
                        id="new_password" 
                        name="new_password" 
                        class="form-input" 
                        required
                        minlength="8"
                        autocomplete="new-password"
                    >
                    <div class="form-hint">At least 8 characters long</div>
                </div>
                
                <div class="form-group">
                    <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                    <input 
                        type="password" 
                        id="confirm_new_password" 
                        name="confirm_new_password" 
                        class="form-input" 
                        required
                        autocomplete="new-password"
                    >
                    <div class="form-error" id="password-match-error"></div>
                </div>
            </div>
            
            {% if password_errors %}
            <div class="alert alert-error">
                {% for error in password_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if password_success %}
            <div class="alert alert-success">
                {{ password_success }}
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    Change Password
                </button>
            </div>
        </form>
    </div>

    <!-- API Keys Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>API Keys</h2>
            <p>Manage API keys for programmatic access</p>
        </div>
        
        <div class="api-keys-content">
            {% if api_keys and api_keys|length > 0 %}
            <div class="api-keys-list">
                {% for key in api_keys %}
                <div class="api-key-item">
                    <div class="api-key-info">
                        <div class="api-key-name">
                            <strong>{{ key.name if key.name else 'API Key' }}</strong>
                            {% if key.is_active %}
                                <span class="status-badge status-active">Active</span>
                            {% else %}
                                <span class="status-badge status-inactive">Inactive</span>
                            {% endif %}
                        </div>
                        <div class="api-key-details">
                            <span>Created: {{ key.created_at.strftime('%B %d, %Y') if key.created_at else 'Unknown' }}</span>
                            {% if key.last_used %}
                            <span>Last used: {{ key.last_used.strftime('%B %d, %Y') }}</span>
                            {% else %}
                            <span>Never used</span>
                            {% endif %}
                        </div>
                        <div class="api-key-value">
                            <input type="text" class="api-key-input" value="{{ key.masked_key }}" readonly>
                            <button type="button" class="btn btn-outline btn-sm" onclick="copyApiKey(this)">
                                Copy
                            </button>
                        </div>
                    </div>
                    <div class="api-key-actions">
                        <form action="/auth/api-keys/{{ key.id }}/revoke" method="post" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to revoke this API key?')">
                                Revoke
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No API keys created yet</p>
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="generateApiKey()">
                    Generate New API Key
                </button>
            </div>
        </div>
    </div>

    <!-- Account Actions Section -->
    <div class="profile-section">
        <div class="section-header">
            <h2>Account Actions</h2>
            <p>Manage your account settings</p>
        </div>
        
        <div class="account-actions">
            <form action="/auth/logout" method="post" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                <button type="submit" class="btn btn-outline">
                    Sign Out
                </button>
            </form>
            
            <button type="button" class="btn btn-danger" onclick="showDeleteAccountModal()">
                Delete Account
            </button>
        </div>
    </div>
</div>

<style>
.profile-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.profile-header {
    text-align: center;
    margin-bottom: 3rem;
}

.profile-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.profile-header p {
    color: #6b7280;
}

.profile-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.section-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.section-header p {
    color: #6b7280;
    font-size: 0.875rem;
}

.profile-form {
    space-y: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input[readonly] {
    background-color: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
}

.form-hint {
    color: #6b7280;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.form-error {
    color: #ef4444;
    font-size: 0.75rem;
    margin-top: 0.25rem;
    min-height: 1rem;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
}

.alert {
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.alert-error {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.alert-success {
    background-color: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
}

.btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 500;
    text-align: center;
    text-decoration: none;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background-color: #2563eb;
}

.btn-secondary {
    background-color: #f9fafb;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-secondary:hover {
    background-color: #f3f4f6;
}

.btn-outline {
    background-color: transparent;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-outline:hover {
    background-color: #f9fafb;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}

.api-keys-list {
    space-y: 1rem;
}

.api-key-item {
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 1rem;
    display: flex;
    justify-content: between;
    align-items: flex-start;
    gap: 1rem;
}

.api-key-info {
    flex: 1;
}

.api-key-name {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.api-key-details {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.api-key-details span {
    margin-right: 1rem;
}

.api-key-value {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.api-key-input {
    flex: 1;
    font-family: monospace;
    font-size: 0.75rem;
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background-color: #f9fafb;
}

.status-badge {
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-active {
    background-color: #d1fae5;
    color: #065f46;
}

.status-inactive {
    background-color: #fef2f2;
    color: #991b1b;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
}

.account-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
}

/* Responsive design */
@media (max-width: 640px) {
    .profile-container {
        padding: 1rem;
    }
    
    .profile-section {
        padding: 1.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        justify-content: stretch;
    }
    
    .form-actions .btn {
        flex: 1;
    }
    
    .account-actions {
        flex-direction: column;
    }
}
</style>

<script>
// Password confirmation validation
document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_new_password');
    const errorDiv = document.getElementById('password-match-error');
    
    function validatePasswordMatch() {
        if (confirmPassword.value && newPassword.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
            errorDiv.textContent = 'Passwords do not match';
        } else {
            confirmPassword.setCustomValidity('');
            errorDiv.textContent = '';
        }
    }
    
    newPassword.addEventListener('input', validatePasswordMatch);
    confirmPassword.addEventListener('input', validatePasswordMatch);
});

// Copy API key to clipboard
function copyApiKey(button) {
    const input = button.previousElementSibling;
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(input.value).then(function() {
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = 'Copy';
        }, 2000);
    });
}

// Generate new API key
function generateApiKey() {
    if (confirm('Generate a new API key? Make sure to copy it immediately as it will only be shown once.')) {
        // This would trigger an HTMX request or form submission
        window.location.href = '/auth/api-keys/generate';
    }
}

// Show delete account modal
function showDeleteAccountModal() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        if (confirm('This will permanently delete all your data. Type "DELETE" to confirm.')) {
            // This would trigger account deletion
            alert('Account deletion functionality would be implemented here');
        }
    }
}
</script>
{% endblock %} 