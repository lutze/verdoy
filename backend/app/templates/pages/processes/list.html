{% extends "base.html" %}

{% block title %}Process Designer - LMS Core{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Enhanced Page Header -->
    <div class="page-header mb-8">
        <div class="page-header-content">
            <div>
                <h1 class="page-title">Process Designer</h1>
                <p class="page-subtitle">Create, manage, and execute process workflows for your bioreactors</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary">
                    üìä Analytics
                </button>
                <button class="btn btn-secondary">
                    üìã Templates
                </button>
                <a href="/app/processes/create" class="btn btn-primary">
                    ‚ûï Create Process
                </a>
            </div>
        </div>
    </div>

    <!-- Enhanced Controls -->
    <form method="GET" class="controls-section mb-6">
        <div class="controls-content">
            <div class="search-filters">
                <div class="search-box">
                    <div class="search-icon">üîç</div>
                    <input type="text" class="search-input" placeholder="Search processes..." name="search" value="{{ filters.search or '' }}">
                </div>
                <select name="process_type" class="filter-select">
                    <option value="">All Types</option>
                    {% for process_type in process_types %}
                    <option value="{{ process_type }}" {% if filters.process_type == process_type %}selected{% endif %}>
                        {{ process_type.replace('_', ' ').title() }}
                    </option>
                    {% endfor %}
                </select>
                <select name="status" class="filter-select">
                    <option value="">All Statuses</option>
                    {% for status in statuses %}
                    <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>
                        {{ status.replace('_', ' ').title() }}
                    </option>
                    {% endfor %}
                </select>
                <select name="is_template" class="filter-select">
                    <option value="">All</option>
                    <option value="true" {% if filters.is_template == 'true' %}selected{% endif %}>Templates Only</option>
                    <option value="false" {% if filters.is_template == 'false' %}selected{% endif %}>Processes Only</option>
                </select>
                <button type="submit" class="btn btn-primary">
                    Filter
                </button>
            </div>
            <div class="view-toggles">
                <button type="button" class="view-toggle active" id="grid-view" title="Grid View">‚öè</button>
                <button type="button" class="view-toggle" id="list-view" title="List View">‚ò∞</button>
            </div>
        </div>
    </form>

    <!-- Error Message -->
    {% if error %}
    <div class="alert alert-error mb-6">
        <p>{{ error }}</p>
    </div>
    {% endif %}

    <!-- Processes Grid View -->
    {% if processes %}
    <div class="processes-grid" id="processes-grid">
        {% for process in processes %}
        <div class="process-card">
            <div class="process-header">
                <div class="process-status status-{{ process.status }}">
                    ‚óè {{ process.status.replace('_', ' ').title() }}
                </div>
                {% if process.is_template %}
                <div class="process-template-badge">Template</div>
                {% endif %}
                <h3 class="process-name">{{ process.name }}</h3>
                {% if process.description %}
                <p class="process-description">{{ process.description }}</p>
                {% endif %}
                <div class="process-progress">
                    <div class="progress-label">
                        <span>Status</span>
                        <span>{{ process.status.replace('_', ' ').title() }}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill {% if process.status == 'active' %}progress-fill-100{% elif process.status == 'draft' %}progress-fill-25{% elif process.status == 'archived' %}progress-fill-0{% else %}progress-fill-50{% endif %}"></div>
                    </div>
                </div>
            </div>
            
            <div class="process-stats">
                <div class="stat">
                    <span class="stat-number">{{ process.step_count }}</span>
                    <span class="stat-label">Steps</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ process.version }}</span>
                    <span class="stat-label">Version</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ process.process_type.replace('_', ' ').title() }}</span>
                    <span class="stat-label">Type</span>
                </div>
            </div>
            
            <div class="process-details">
                <div class="detail-item">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">{{ process.process_type.replace('_', ' ').title() }}</span>
                </div>
                
                <div class="detail-item">
                    <span class="detail-label">Version:</span>
                    <span class="detail-value">{{ process.version }}</span>
                </div>
                
                {% if process.estimated_duration %}
                <div class="detail-item">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value">{{ process.estimated_duration }} min</span>
                </div>
                {% endif %}
                
                <div class="detail-item">
                    <span class="detail-label">Updated:</span>
                    <span class="detail-value">{{ process.updated_at.strftime('%Y-%m-%d') if process.updated_at else 'N/A' }}</span>
                </div>
            </div>
            
            <div class="process-footer">
                <div class="process-info">
                    {% if process.is_template %}
                    <span class="template-badge">Template</span>
                    {% endif %}
                    
                    {% if process.estimated_duration %}
                    <span class="duration-info">{{ process.estimated_duration }} min</span>
                    {% endif %}
                </div>
                <div class="process-actions">
                    <a href="/app/processes/{{ process.id }}" class="action-btn" title="View Details">üëÅÔ∏è</a>
                    <a href="/app/processes/{{ process.id }}/edit" class="action-btn" title="Edit">‚úèÔ∏è</a>
                    {% if process.status != 'archived' %}
                    <form method="POST" action="/app/processes/{{ process.id }}/archive" class="inline-form">
                        <button type="submit" class="action-btn danger" title="Archive" 
                                onclick="return confirm('Are you sure you want to archive this process?')">
                            üóÑÔ∏è
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Processes List View -->
    <div class="processes-list hidden" id="processes-list">
        <div class="list-header">
            <div>Process Name</div>
            <div>Type</div>
            <div>Status</div>
            <div>Steps</div>
            <div>Version</div>
            <div>Actions</div>
        </div>
        {% for process in processes %}
        <div class="process-row">
            <div class="process-info">
                <strong>{{ process.name }}</strong>
                {% if process.description %}
                <br>
                <small class="process-desc">{{ process.description[:50] }}{% if process.description|length > 50 %}...{% endif %}</small>
                {% endif %}
                {% if process.is_template %}
                <span class="template-badge-small">Template</span>
                {% endif %}
            </div>
            <div>{{ process.process_type.replace('_', ' ').title() }}</div>
            <div><span class="status-{{ process.status }}">‚óè {{ process.status.replace('_', ' ').title() }}</span></div>
            <div>{{ process.step_count }}</div>
            <div>{{ process.version }}</div>
            <div class="process-actions">
                <a href="/app/processes/{{ process.id }}" class="action-btn" title="View">üëÅÔ∏è</a>
                <a href="/app/processes/{{ process.id }}/edit" class="action-btn" title="Edit">‚úèÔ∏è</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total > per_page %}
    <div class="pagination">
        <div class="pagination-info">
            Showing {{ (page - 1) * per_page + 1 }} to 
            {{ page * per_page if page * per_page < total else total }} 
            of {{ total }} processes
        </div>
        
        <div class="pagination-controls">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.process_type %}&process_type={{ filters.process_type }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.is_template %}&is_template={{ filters.is_template }}{% endif %}" 
               class="btn btn-sm btn-outline">Previous</a>
            {% endif %}
            
            <span class="page-info">Page {{ page }} of {{ (total + per_page - 1) // per_page }}</span>
            
            {% if page * per_page < total %}
            <a href="?page={{ page + 1 }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.process_type %}&process_type={{ filters.process_type }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.is_template %}&is_template={{ filters.is_template }}{% endif %}" 
               class="btn btn-sm btn-outline">Next</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Enhanced Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
        </div>
        <h3 class="empty-title">No processes found</h3>
        <p class="empty-description">
            {% if filters.search or filters.process_type or filters.status or filters.is_template %}
            Try adjusting your filters to see more results.
            {% else %}
            Create your first process to begin designing workflows for your bioreactors.
            {% endif %}
        </p>
        <a href="/app/processes/create" class="btn btn-primary">
            Create Process
        </a>
    </div>
    {% endif %}
</div>

<script>
// View toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    const processesGrid = document.getElementById('processes-grid');
    const processesList = document.getElementById('processes-list');

    if (gridView && listView && processesGrid && processesList) {
        gridView.addEventListener('click', () => {
            gridView.classList.add('active');
            listView.classList.remove('active');
            processesGrid.classList.remove('hidden');
            processesList.classList.add('hidden');
        });

        listView.addEventListener('click', () => {
            listView.classList.add('active');
            gridView.classList.remove('active');
            processesGrid.classList.add('hidden');
            processesList.classList.remove('hidden');
        });
    }
});
</script>
{% endblock %} 